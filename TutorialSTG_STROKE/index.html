<div>敵、敵弾、オーディオ再生について説明します。</div><div><u><strong><br></strong></u></div><div><u><strong>◆敵の各ノードの説明</strong></u><br></div><div>シーン構成は以下の通りです。敵は2種類います。Enemyは狙い弾を撃ってきます。Enemy2は放射状に弾を拡散します。<p><strong>Enemy　　　　　　→Area2Dノード<br>
└Sprite<br>
└CollisionShape2D<br>
└AnimationPlayer<br>
└Sound_Bomb　　→AudioStreamPlayerノード<br></strong></p><p><strong>Enemy2　　　　　→Area2Dノード<br>└Sprite<br>└CollisionShape2D<br>└AnimationPlayer<br>└Sound_Bomb　　→AudioStreamPlayerノード<br></strong></p>Enemy、Enemy2とも基本作りは同じでスクリプトが違う程度です。</div><div><p><a href="https://shu-ren.fc2.net/img/teki.png/" target="_blank"><img src="https://blog-imgs-147.fc2.com/i/6/z/i6zyr7er68b9/teki.png" alt="teki.png"></a></p></div><div><p>Sound_Bombで使われている<strong>AudioStreamPlayerノード</strong>について説明します。<br>まず画像右のインスペクターの内容です。</p><p><strong>Stream<br>└再生するファイルを指定する<br>Volume Db<br>└音量(デフォルトは0Db)<br>Pitch Scale<br>└音の高さとテンポを調整する<br>Playing<br>└再生中だとONになる<br>Autoplay<br>└ONだとシーンツリーに追加された時点で再生される<br>StreamPaused<br>└ONにすると一時停止する。OFFにすると続きから再生。<br>Mix Target<br>└2つ以上のスピーカーがある場合などはサラウンドに設定できる。デフォルトはStereo<br>Bus<br>└デフォルトはMaster。スピーカーとヘッドホンなど出力系統を複数使っている場合にそちらも選べるようになる。たぶん。<br></strong></p></div><div>AudioSteramPlayerには他に<strong>AudioSteramPlayer2D</strong>や<strong>AudioSteramPlayer3D</strong>があります。</div><div>これらは距離に応じて音の減衰を変化させる項目が追加されています。</div><div>例えばNPCから離れると話し声が聞こえなくなるなどの設定に使えます。</div><div>今回はファイルを設定しているだけで他はいじっていません。</div><div><p>Sprite、CollisionShape2D、AnimationPlayerについては実際にインスペクターを確認してみましょう。前回のショット処理とやっていることは同じです。<u><br></u></p><p><u><strong>◆スクリプト </strong></u><strong></strong><br></p><p>スクリプトを見てみます。まずはEnemy.gdからです。<br><span style="color: rgb(255, 0, 127);">ピンク</span>の箇所はEnemy2.gdと相違している箇所です。中身はほとんど同じなのです。<span style="color: rgb(255, 0, 127);"><br></span></p>Enemy.gd</div><div><strong><table style="font-size: 10pt; line-height: 16pt; " width="650" cellspacing="1" cellpadding="1" border="2">     <tbody>         <tr>             <td>extends Area2D<br><br><span style="color: rgb(42, 208, 0);">#Bomb、tekishot1をpreloadする。preloadすると先にリソースを読み込んでおくためパフォーマンスが向上する。<br>#これに対するloadはloadがスクリプトで呼ばれたときに読み込みを開始する。</span><br>const bomb = preload("res://tscn/Bomb.tscn")<br>const fire = preload("res://tscn/<span style="color: rgb(255, 0, 127);">tekishot1.tscn</span>")<br><br>var vec = Vector2.ZERO&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#ベクトルを０で初期化</span><br>var speed = <span style="color: rgb(255, 0, 127);">80</span>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#スピード</span><br>var shoottime = <span style="color: rgb(255, 0, 127);">150</span> - Global.level&nbsp; <span style="color: rgb(42, 208, 0);">#弾を発射する間隔</span><br><br><span style="color: rgb(42, 208, 0);">#初期化：出現位置を指定</span><br>func start(pos):<br>&nbsp;&nbsp; &nbsp;position = pos<br><br><span style="color: rgb(42, 208, 0);">#プロセス</span><br>func _process(delta):<br>&nbsp;&nbsp; &nbsp;position.y += speed * delta&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#y座標にspeedを足してdeltaをかける</span><br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(255, 0, 127);">$AnimationPlayer.play("rot")</span>&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#アニメーション再生</span><br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(255, 0, 127);">rotation -= 0.1</span>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#スプライト回転</span><br>&nbsp;&nbsp; &nbsp;shoot()&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#弾を撃つ関数を呼び出す</span><br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;if position.y &gt; 480:&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#画面下を抜けたら削除</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;queue_free()<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;shoottime -= 1&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#shoottimeを1減らす</span><br><br><span style="color: rgb(42, 208, 0);">#死亡時の処理<br>#スコア+1して爆発エフェクトを呼び出し、自分自身は削除する。</span><br>func hit():<br>&nbsp;&nbsp; &nbsp;Global.score += <span style="color: rgb(255, 0, 127);">1</span><br>&nbsp;&nbsp; &nbsp;var b = bomb.instance()<br>&nbsp;&nbsp; &nbsp;b.start(position)<br>&nbsp;&nbsp; &nbsp;get_parent().add_child(b)<br>&nbsp;&nbsp; &nbsp;queue_free()<br><br><span style="color: rgb(42, 208, 0);">#弾発射処理</span><br>func shoot():<br>&nbsp;&nbsp; &nbsp;if shoottime &lt; 0:&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#shooottimeが0より小さいなら</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span style="color: rgb(255, 0, 127);">var f = fire.instance()</span>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#弾のインスタンス作る</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span style="color: rgb(255, 0, 127);">f.start(position)</span>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: rgb(42, 208, 0);">#弾の初期位置を指定</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;get_parent().add_child(f)&nbsp;&nbsp; &nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#ノードに追加</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;shoottime = <span style="color: rgb(255, 0, 127);">150</span> - Global.level&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#shooottimeを150に戻す(Global.levelが上がると発射間隔が短くなる)</span><br></td></tr></tbody> </table></strong><p>最初はここです。</p><p><strong><span style="color: rgb(42, 208, 0);">#Bomb、tekishot1をpreloadする。preloadすると先にリソースを読み込んでおくためパフォーマンスが向上する。<br>#これに対するloadはloadがスクリプトで呼ばれたときに読み込みを開始する。</span><br>const bomb = preload("res://tscn/Bomb.tscn")<br>const fire = preload("res://tscn/tekishot1.tscn")</strong></p><p>敵キャラクターは弾を発射し、死亡すると爆発します。そのためtekishot1.tscnとBomb.tscnという<strong>外部のシーンを動的に生成</strong>しなくてはなりません。これを実現するためにEnemy.gdの最初にpreload()を記述します。<br>コメントに書いてある通り普通のload()ではload()が呼ばれたタイミングでHDDやSSDにアクセスし読み込みを開始します。<br>対するpreload()はこのシーンがロードされるときに読み込を開始します。</p><p><strong><span style="color: rgb(42, 208, 0);">#プロセス</span><br>func _process(delta):<br>&nbsp;&nbsp;&nbsp; position.y += speed * delta&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#y座標にspeedを足してdeltaをかける</span><br>&nbsp;&nbsp;&nbsp; $AnimationPlayer.play("rot")&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#アニメーション再生</span><br>&nbsp;&nbsp;&nbsp; rotation -= 0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#スプライト回転</span><br>&nbsp;&nbsp;&nbsp; shoot()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#弾を撃つ関数を呼び出す</span><br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; if position.y &gt; 480:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#画面下を抜けたら削除</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; queue_free()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp;&nbsp; shoottime -= 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#shoottimeを1減らす</span></strong></p><p><span style="color: rgb(15, 36, 62);">process()もショット処理と似ています。Enemyはアニメーションもしますがrotation -= 0.1で回転もします。<br>shoot()は弾を撃つ処理で次で説明します。<br>後は画面外に出たら削除します。<br>shoottimeは敵が弾を撃ってくる間隔を調整しています。ショット処理の時と同じで常に-1しています。<br>これはゲームの進行と共に上昇する難易度と連動しています。難易度上昇については別の回で説明しましょう。</span></p><p><strong><span style="color: rgb(42, 208, 0);">#死亡時の処理<br>#スコア+1して爆発エフェクトを呼び出し、自分自身は削除する。</span><br>func hit():<br>&nbsp;&nbsp;&nbsp; Global.score += 1<br>&nbsp;&nbsp;&nbsp; var b = bomb.instance()<br>&nbsp;&nbsp;&nbsp; b.start(position)<br>&nbsp;&nbsp;&nbsp; get_parent().add_child(b)<br>&nbsp;&nbsp;&nbsp; queue_free()</strong></p><p>そしてこれが前回説明した敵死亡時のhit()メソッドです。<br>これが呼び出されるとスコアを+1して、爆発を発生させ、敵を削除します。</p><p><strong><span style="color: rgb(42, 208, 0);">#弾発射処理</span><br>func shoot():<br>&nbsp;&nbsp;&nbsp; if shoottime &lt; 0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#shooottimeが0より小さいなら</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var f = fire.instance()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#弾のインスタンス作る</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f.start(position)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#弾の初期位置を指定</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get_parent().add_child(f)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#ノードに追加</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shoottime = 150 - Global.level&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#shooottimeを150に戻す(Global.levelが上がると発射間隔が短くなる)</span></strong></p><p><span style="color: rgb(0, 0, 0);">process()で実行される弾を撃つshoot()メソッドです。<br>先程説明したshoottimeが0より小さいなら弾をインスタンス化→初期位置指定→add_childするといういつもの流れです。<br></span></p><p><span style="color: rgb(0, 0, 0);">そしてshoottimeを150に設定し</span>ます。Global.levelが難易度です。</p><p><strong></strong></p><p><strong></strong></p></div><div><p><strong></strong></p></div><div><hr></div><div><p>次は<strong>Enemy2.gd</strong>について解説しますが長いので大きく違う<strong>shoot()</strong>メソッドのみ解説します。それ以外はほとんど同じなので自分で確認してみましょう。</p><p><strong><span style="color: rgb(42, 208, 0);">#弾発射処理</span><br>func shoot():<br>&nbsp;&nbsp; &nbsp;if shoottime &lt; 0:&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#shoottimeが0より小さければ</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; for i in range(Global.level/8):&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#forを「Global.level/8」の回数回す</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; var f = fire.instance()&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; <span style="color: rgb(42, 208, 0);">#弾のインスタンス作成</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; f.start(position.x, position.y, i)&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#弾の初期位置を指定、iの数だけ360度方向に発射する</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; get_parent().add_child(f)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#ノードに追加</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; shoottime = 200 - Global.level&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#shooottimeを200に戻す(Global.levelが上がると発射間隔が短くなる)</span></strong><span style="color: rgb(42, 208, 0);"></span></p><p><span style="color: rgb(0, 0, 0);">Enemyは狙い弾(tekishot1.tscn)をロードしていますが、Enemy2は方向弾(tekishot2.tscn)をロードしています。なのでここでの<strong>fire</strong>はtekishot2.tscnが入っています。<br></span>「for i in range(Global.level/8):」という箇所ですが、Enemy2は「Global.level」を「8」で割った複数方向に弾を同時に飛ばします。難易度が上昇するとカウンター「i」が増え、同時発射数も増えます。<br>インスタンス化後の「f.start(position.x, position.y, i)」は引数が3つあります。3つ目が「i」になっており発射数を設定しています。同時にstart()メソッド内ではrotated()を使って各弾の発射角度も設定しています。</p><p>Enemyの説明は以上になります。</p></div><div><hr><p><u><strong>◆敵弾の各ノードの説明</strong></u></p></div><div>敵弾も2種類あります。tekishot1は狙い弾、tekishot2は方向弾です。</div><br><div><strong>tekishot1　　　　　　→Area2Dノード</strong></div><div><strong>└Sprite</strong></div><div><strong>└CollisionShape2D</strong></div><div><strong>└AnimationPlayer</strong></div><div><strong><br></strong></div><div><strong>tekishot2　　　　　　→Area2Dノード</strong></div><div><strong>└Sprite</strong></div><div><strong>└CollisionShape2D</strong></div><div><strong>└AnimationPlayer</strong></div><div><br></div><div>tekishot1、tekishot2とも基本作りは同じでスクリプトが違うだけです。<br>ノードの中身も特に説明する部分もなく今まで散々やってきた敵やショット処理と似たものになっているので割愛します。</div><div><p><u><strong>◆スクリプト</strong></u></p></div><div>tekishot1.gd</div><div>
 </div><table style="font-size: 10pt; line-height: 16pt; " width="650" cellspacing="1" cellpadding="1" border="2">     <tbody>         <tr>             <td>extends Area2D<br><br><span style="color: rgb(42, 208, 0);">#Bombをpreloadする。preloadすると先にリソースを読み込んでおくためパフォーマンスが向上する。<br>#これに対するloadはloadがスクリプトで呼ばれたときに読み込みを開始する。</span><br>const bomb = preload("res://tscn/Bomb.tscn")<br><br>var vec = Vector2.ZERO&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#ベクトル</span><br>var speed = 100&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#弾の移動スピード</span><br><br><span style="color: rgb(42, 208, 0);">#初期化：狙い弾</span><br><span style="color: rgb(255, 0, 127);">func start(pos):</span><br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#発射位置をposで指定</span><br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(255, 0, 127);">position = pos</span>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#「is_instance_valid」はそのノードが存在しているか否かを判定してくれる<br>&nbsp;&nbsp; &nbsp;#プレイヤーノードが存在し、ライフが0でなければ、<br>&nbsp;&nbsp; &nbsp;#プレイヤー座標 - 狙い弾座標をvecに代入する<br>&nbsp;&nbsp; &nbsp;#プレイヤーが存在していなければ、ベクトルは下方向にする</span>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(255, 0, 127);">if is_instance_valid(Global.jikinode) == true and Global.life != 0:</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<span style="color: rgb(255, 0, 127);">vec = Global.jikinode.global_position - global_position<br>&nbsp;&nbsp; &nbsp;else:<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;vec = Vector2.DOWN</span><br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#ベクトルの正規化</span><br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(255, 0, 127);">vec = vec.normalized()</span><br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#atan2で狙う方向を定める</span><br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(255, 0, 127);">global_rotation = atan2(vec.y, vec.x)</span><br><br><span style="color: rgb(42, 208, 0);">#プロセス</span><br>func _process(delta):<br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#弾の移動処理</span><br>&nbsp;&nbsp; &nbsp;position += vec * speed * delta<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#範囲処理</span><br>&nbsp;&nbsp; &nbsp;if position.x &gt; 640 or position.x &lt; 0 or position.y &gt; 480 or position.x &lt; 0:<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;queue_free()<br><br><span style="color: rgb(42, 208, 0);">#弾が当たったときに呼び出す関数<br>#爆発エフェクトが発生し、弾を削除する</span><br>func hit():<br>&nbsp;&nbsp; &nbsp;var b = bomb.instance()<br>&nbsp;&nbsp; &nbsp;b.start(position)<br>&nbsp;&nbsp; &nbsp;get_parent().add_child(b)<br>&nbsp;&nbsp; &nbsp;queue_free()<br></td></tr></tbody> </table><div><p>ここまで読み進めて来れた方なら、説明すべき点は<span style="color: rgb(255, 0, 127);">ピンク</span>箇所の<strong>start()</strong>メソッドだけです。<br>まず最初にposition = posとしていますposの中身は<strong>Vecter2型</strong>が入ります。<br></p><p><strong>if is_instance_valid(Global.jikinode) == true and Global.life != 0:</strong><br><strong>&nbsp;&nbsp;&nbsp; vec = Global.jikinode.global_position - global_position<br>else:<br>&nbsp;&nbsp;&nbsp; vec = Vector2.DOWN</strong></p><p>次のところはコメント通りなのですが「if is_instance_valid(Global.jikinode) == true and Global.life != 0:」という条件式でプレイヤーキャラクターが存在しているかどうか、プレイヤーの残機数が0でないか判定しています。<br>存在していれば「プレイヤー座標 - 狙い弾座標」をvecに代入します。<br>そうでない場合は真下に弾を発射させます。この処理がないとプレイヤーキャラ死亡時に敵弾はプレイヤー座標を参照できずその場に停止した弾を置いていくことになります。</p><p>　<strong><span style="color: rgb(42, 208, 0);">#ベクトルの正規化</span><br>&nbsp;&nbsp;&nbsp; vec = vec.normalized()<br>&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#atan2で狙う方向を定める</span><br>&nbsp;&nbsp;&nbsp; global_rotation = atan2(vec.y, vec.x)</strong></p><p>次にベクトルを正規化し、atan2()で敵弾の方向を決定します。<br>atan2()は狙い弾の処理でよく使われます。先程の「プレイヤー座標 - 狙い弾座標」という二点間のxとyを先に求め、atan2()でその長さから角度θを求められます。その角度をglobal_rotationに代入すればプレイヤーの方向に弾が飛ぶわけです。<br>因みにこれは初期化する際に一回だけatan2()で計算していますが、process()で常にatan2()で角度を求めると<strong>絶対に逃げられない追尾弾</strong>が作れます。<br>追尾する角度に少し制限をかける処理を施してやると追尾性能が下がり、シューティングゲームおなじみの追尾ミサイルが作れます。<br></p><p>というわけでtekishot1はここまでです。次はtekishot2です。</p><hr><p>tekishot2のスクリプトも説明すべき点は<span style="color: rgb(255, 0, 127);">ピンク</span>箇所の<strong>start()</strong>メソッドだけですね。</p>tekishot2.gd
 <table style="font-size: 10pt; line-height: 16pt; " width="650" cellspacing="1" cellpadding="1" border="2">     <tbody>         <tr>             <td>extends Area2D<br><br><span style="color: rgb(42, 208, 0);">#Bombをpreloadする。preloadすると先にリソースを読み込んでおくためパフォーマンスが向上する。<br>#これに対するloadはloadがスクリプトで呼ばれたときに読み込みを開始する。</span><br>const bomb = preload("res://tscn/Bomb.tscn")<br><br>var vec = Vector2.DOWN&nbsp;&nbsp; &nbsp;<span style="color: rgb(42, 208, 0);">#ベクトル。下向きにしている</span><br>var speed = 150&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: rgb(42, 208, 0);">#弾の移動スピード</span><br><br><span style="color: rgb(42, 208, 0);">#初期化：xとy、発射方向を指定</span><br><span style="color: rgb(255, 0, 127);">func start(x, y, rot):<br>&nbsp;&nbsp; &nbsp;position.x = x<br>&nbsp;&nbsp; &nbsp;position.y = y<br>&nbsp;&nbsp; &nbsp;vec = vec.rotated(rot)<br>&nbsp;&nbsp; &nbsp;vec = vec.normalized()</span><br><br><span style="color: rgb(42, 208, 0);">#プロセス：弾の移動処理、範囲処理</span><br>func _process(delta):<br>&nbsp;&nbsp; &nbsp;position += vec * speed * delta<br>&nbsp;&nbsp; &nbsp;<br>&nbsp;&nbsp; &nbsp;if position.x &gt; 640 or position.x &lt; 0 or position.y &gt; 480 or position.x &lt; 0:<br>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;queue_free()<br><br><span style="color: rgb(42, 208, 0);">#弾がヒットした際は爆発エフェクトを呼び出して、弾は消す処理</span><br>func hit():<br>&nbsp;&nbsp; &nbsp;var b = bomb.instance()<br>&nbsp;&nbsp; &nbsp;b.start(position)<br>&nbsp;&nbsp; &nbsp;get_parent().add_child(b)<br>&nbsp;&nbsp; &nbsp;queue_free()<br></td></tr></tbody> </table></div><div><p>start()の最初でまずxとyをpositionに代入します。<br>「vec = vec.rotated(rot)」で角度を指定しています。<br>この「rot」はEnemy2.gdのshoot()メソッドと合わせてみるとわかります。「for i in range(Global.level/8): 」の「i」が入っているのです。つまり難易度上昇と共に敵弾の数が増えると放射する角度が狭くなるようにしているのです。<br>そして最後にnormalized()して終わりです。<br>他の箇所は見ての通りこれまで見てきたものと同じような処理です。これでtekishot2は終わりです。</p><p>次回はエフェクト処理を解説します。<br>これで山場は越えたので後はそれほど難しくありません。<br>ゲームメイン処理、ゲームオーバー処理、スコアなどなど細かいところです。<br></p></div>